<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Python Socket | suda-morris&#39;s Personal Blog | Geek makes life better.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Socket">
    <meta name="description" content="Python中的Socket编程Python标准库中的socket模块 socket对象支持使用TCP或者UDP协议进行网络通信，并提供了socket编程所需要的对象、函数和常量  简单TCP服务器实例123456789101112131415161718192021222324# -*- coding: utf-8 -*-import socketserver_host = &quot;192.168.1">
<meta name="keywords" content="Socket">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Socket">
<meta property="og:url" content="https://suda-morris.github.io/2018/10/17/python-socket/index.html">
<meta property="og:site_name" content="suda-morris&#39;s Personal Blog">
<meta property="og:description" content="Python中的Socket编程Python标准库中的socket模块 socket对象支持使用TCP或者UDP协议进行网络通信，并提供了socket编程所需要的对象、函数和常量  简单TCP服务器实例123456789101112131415161718192021222324# -*- coding: utf-8 -*-import socketserver_host = &quot;192.168.1">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://s1.ax1x.com/2018/10/17/idOnEQ.png">
<meta property="og:updated_time" content="2018-10-17T14:55:41.302Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python Socket">
<meta name="twitter:description" content="Python中的Socket编程Python标准库中的socket模块 socket对象支持使用TCP或者UDP协议进行网络通信，并提供了socket编程所需要的对象、函数和常量  简单TCP服务器实例123456789101112131415161718192021222324# -*- coding: utf-8 -*-import socketserver_host = &quot;192.168.1">
<meta name="twitter:image" content="https://s1.ax1x.com/2018/10/17/idOnEQ.png">
    
        <link rel="alternate" type="application/atom+xml" title="suda-morris&#39;s Personal Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">suda-morris</h5>
          <a href="mailto:362953310@qq.com" title="362953310@qq.com" class="mail">362953310@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags">
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories">
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/suda-morris" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/wenris" target="_blank">
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about" target="_blank">
                <i class="icon icon-lg icon-info"></i>
                About
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Python Socket</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Python Socket</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-10-17T14:36:12.000Z" itemprop="datePublished" class="page-time">
  2018-10-17
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Python/">Python</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Python中的Socket编程"><span class="post-toc-number">1.</span> <span class="post-toc-text">Python中的Socket编程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Python标准库中的socket模块"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Python标准库中的socket模块</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简单TCP服务器实例"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">简单TCP服务器实例</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简单TCP客户端实例"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">简单TCP客户端实例</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简单UDP服务器实例"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">简单UDP服务器实例</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#简单UDP客户端实例"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">简单UDP客户端实例</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#小项目—备份服务器与客户端的简单实现-多线程版"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">小项目—备份服务器与客户端的简单实现(多线程版)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#服务器"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">服务器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#客户端"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">客户端</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SocketServer框架"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">SocketServer框架</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SocketServer框架下的TCP服务器"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">SocketServer框架下的TCP服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配套的TCP客户端"><span class="post-toc-number">1.3.1.1.</span> <span class="post-toc-text">配套的TCP客户端</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SocketServer框架下的UDP服务器"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">SocketServer框架下的UDP服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配套的UDP客户端"><span class="post-toc-number">1.3.2.1.</span> <span class="post-toc-text">配套的UDP客户端</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用SocketServer框架改写备份服务器程序"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">使用SocketServer框架改写备份服务器程序</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#项目：简单FTP服务器与客户端的实现"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">项目：简单FTP服务器与客户端的实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#FTP服务器的实现"><span class="post-toc-number">1.5.1.</span> <span class="post-toc-text">FTP服务器的实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#FTP客户端的实现"><span class="post-toc-number">1.5.2.</span> <span class="post-toc-text">FTP客户端的实现</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-python-socket" class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Python Socket</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-10-17 22:36:12" datetime="2018-10-17T14:36:12.000Z" itemprop="datePublished">2018-10-17</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Python/">Python</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none">
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Python中的Socket编程"><a href="#Python中的Socket编程" class="headerlink" title="Python中的Socket编程"></a>Python中的Socket编程</h1><h2 id="Python标准库中的socket模块"><a href="#Python标准库中的socket模块" class="headerlink" title="Python标准库中的socket模块"></a>Python标准库中的socket模块</h2><blockquote>
<p>socket对象支持使用TCP或者UDP协议进行网络通信，并提供了socket编程所需要的对象、函数和常量</p>
</blockquote>
<h3 id="简单TCP服务器实例"><a href="#简单TCP服务器实例" class="headerlink" title="简单TCP服务器实例"></a>简单TCP服务器实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.103"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 本套接字是建立在IPv4基础上的流式套接字</span></span><br><span class="line">    server_sock.bind((server_host, server_port))  <span class="comment"># 绑定本地地址和端口号</span></span><br><span class="line">    server_sock.listen(<span class="number">5</span>)  <span class="comment"># 使能监听</span></span><br><span class="line"></span><br><span class="line">    client_sock, client_addr_info = server_sock.accept()  <span class="comment"># 阻塞，等待客户端连接</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = client_sock.recv(<span class="number">1024</span>)  <span class="comment"># 接收数据</span></span><br><span class="line">        data = data.decode(<span class="string">"utf-8"</span>)  <span class="comment"># 数据解码</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">"Receive from Client[&#123;addr_info&#125;]:&#123;content&#125;"</span>.format(addr_info=client_addr_info, content=data))</span><br><span class="line">        data = data + <span class="string">"--&gt; OK"</span></span><br><span class="line">        client_sock.send(data.encode(<span class="string">"utf-8"</span>))  <span class="comment"># 发送数据给客户端</span></span><br><span class="line"></span><br><span class="line">    client_sock.close()  <span class="comment"># 关闭客户端套接字</span></span><br><span class="line">    server_sock.close()  <span class="comment"># 关闭服务端套接字</span></span><br></pre></td></tr></table></figure>
<h3 id="简单TCP客户端实例"><a href="#简单TCP客户端实例" class="headerlink" title="简单TCP客户端实例"></a>简单TCP客户端实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.103"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    client_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 本套接字是建立在IPv4基础上的流式套接字</span></span><br><span class="line">    client_sock.connect((server_host, server_port))  <span class="comment"># 向服务器发起连接</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = input(<span class="string">"Please Enter a Message to Send: "</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            client_sock.send(data.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">            <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data = client_sock.recv(<span class="number">1024</span>)</span><br><span class="line">            data = data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">            print(<span class="string">"Receive from Server: &#123;content&#125;"</span>.format(content=data))</span><br><span class="line">    client_sock.close()</span><br></pre></td></tr></table></figure>
<h3 id="简单UDP服务器实例"><a href="#简单UDP服务器实例" class="headerlink" title="简单UDP服务器实例"></a>简单UDP服务器实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.103"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    server_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)  <span class="comment"># 本套接字是建立在IPv4基础上的数据报套接字</span></span><br><span class="line">    server_sock.bind((server_host, server_port))  <span class="comment"># 绑定IP地址和端口号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data, client_addr_info = server_sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">        data = data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        print(<span class="string">"Receive from Client[&#123;addr_info&#125;]:&#123;content&#125;"</span>.format(addr_info=client_addr_info, content=data))</span><br><span class="line">        data = data + <span class="string">" --&gt; OK"</span></span><br><span class="line">        server_sock.sendto(data.encode(<span class="string">"utf-8"</span>), client_addr_info)</span><br><span class="line">    server_sock.close()</span><br></pre></td></tr></table></figure>
<h3 id="简单UDP客户端实例"><a href="#简单UDP客户端实例" class="headerlink" title="简单UDP客户端实例"></a>简单UDP客户端实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.103"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    client_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)  <span class="comment"># 本套接字是建立在IPv4基础上的数据报套接字</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = input(<span class="string">"Please Enter a Message to Send: "</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            client_sock.sendto(data.encode(<span class="string">"utf-8"</span>), (server_host, server_port))</span><br><span class="line">            <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data, server_addr_info = client_sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">            data = data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">            print(<span class="string">"Receive from Server[&#123;addr_info&#125;]:&#123;content&#125;"</span>.format(addr_info=server_addr_info, content=data))</span><br><span class="line">    client_sock.close()</span><br></pre></td></tr></table></figure>
<h2 id="小项目—备份服务器与客户端的简单实现-多线程版"><a href="#小项目—备份服务器与客户端的简单实现-多线程版" class="headerlink" title="小项目—备份服务器与客户端的简单实现(多线程版)"></a>小项目—备份服务器与客户端的简单实现(多线程版)</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="https://s1.ax1x.com/2018/10/17/idOnEQ.png" alt="bak_server_protocol" title="">
                </div>
                <div class="image-caption">bak_server_protocol</div>
            </figure>
<h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter.ttk <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEFAULT_BAK_PATH = <span class="string">r"E:\MyBak"</span>  <span class="comment"># 服务器端默认备份路径</span></span><br><span class="line"></span><br><span class="line">SERV_RUN_FLAG = <span class="keyword">True</span>  <span class="comment"># 服务器运行标志</span></span><br><span class="line">flag_lock = threading.Lock()  <span class="comment"># 运行标志的指令锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file_infos</span><span class="params">(client)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    接受客户端传来的文件列表信息</span></span><br><span class="line"><span class="string">    :param client:客户端连接套接字</span></span><br><span class="line"><span class="string">    :return:data要备份的文件列表信息，compress是否是压缩文件</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    fmt_str = <span class="string">'Q?'</span>  <span class="comment"># 长整形+布尔型</span></span><br><span class="line">    headsize = struct.calcsize(fmt_str)</span><br><span class="line">    data = client.recv(headsize)  <span class="comment"># 接受文件信息列表的长度</span></span><br><span class="line">    infos_len, compress = struct.unpack(fmt_str, data)  <span class="comment"># unpack字节数据</span></span><br><span class="line">    data = <span class="string">b""</span>  <span class="comment"># 保存文件列表信息</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:  <span class="comment"># 每次最多接收1K字节</span></span><br><span class="line">        <span class="keyword">if</span> infos_len &gt; <span class="number">1024</span>:</span><br><span class="line">            data += client.recv(<span class="number">1024</span>)</span><br><span class="line">            infos_len -= <span class="number">1024</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data += client.recv(infos_len)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    data = pickle.loads(data)  <span class="comment"># 使用pickle反序列化</span></span><br><span class="line">    <span class="keyword">return</span> data, compress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mk_file_path</span><span class="params">(filepath_rel)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据文件的相对路径创建服务器端的路径</span></span><br><span class="line"><span class="string">    :param filepath_rel: 客户端文件的相对路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    paths = filepath_rel.split(os.path.sep)[:<span class="number">-1</span>]  <span class="comment"># 按照目录级别切分，去掉最后一项(文件名)</span></span><br><span class="line">    p = DEFAULT_BAK_PATH</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> paths:</span><br><span class="line">        p = os.path.join(p, path)  <span class="comment"># 逐级创建文件夹</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(p):</span><br><span class="line">            os.mkdir(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_compress_size</span><span class="params">(client)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取压缩文件的大小</span></span><br><span class="line"><span class="string">    :param client: 客户端连接套接字</span></span><br><span class="line"><span class="string">    :return: size压缩文件的大小</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    fmt_str = <span class="string">'Q'</span>  <span class="comment"># 长整型</span></span><br><span class="line">    size = struct.calcsize(fmt_str)</span><br><span class="line">    data = client.recv(size)</span><br><span class="line">    size = struct.unpack(fmt_str, data)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv_file</span><span class="params">(client, filepath_rel, file_size, compress)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    接收并保存单个文件</span></span><br><span class="line"><span class="string">    :param client:客户端连接套接字</span></span><br><span class="line"><span class="string">    :param filepath_rel:文件的相对地址</span></span><br><span class="line"><span class="string">    :param file_size:文件大小</span></span><br><span class="line"><span class="string">    :param compress:是否是压缩文件</span></span><br><span class="line"><span class="string">    :return:返回接收成功与否</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    res = <span class="keyword">True</span></span><br><span class="line">    mk_file_path(filepath_rel)</span><br><span class="line">    filepath = os.path.join(DEFAULT_BAK_PATH, filepath_rel)  <span class="comment"># 文件在服务器端的完整路径</span></span><br><span class="line">    <span class="keyword">if</span> compress:</span><br><span class="line">        file_size = get_compress_size(client)</span><br><span class="line">        filepath = <span class="string">""</span>.join([os.path.splitext(filepath)[<span class="number">0</span>], <span class="string">".tar.gz"</span>])  <span class="comment"># 修改文件拓展名</span></span><br><span class="line">    f = open(filepath, <span class="string">"wb+"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">if</span> file_size &gt; <span class="number">1024</span>:</span><br><span class="line">                data = client.recv(<span class="number">1024</span>)</span><br><span class="line">                f.write(data)</span><br><span class="line">                file_size -= <span class="number">1024</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                data = client.recv(file_size)</span><br><span class="line">                f.write(data)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        res = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_echo</span><span class="params">(client, result)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    发送当前文件的备份结果给客户端</span></span><br><span class="line"><span class="string">    :param client: 客户端连接的套接字</span></span><br><span class="line"><span class="string">    :param result: 当前文件备份的结果</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        client.send(<span class="string">b"success"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        client.send(<span class="string">b"failure"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client_operate</span><span class="params">(client_sock)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    客户端处理线程</span></span><br><span class="line"><span class="string">    :param client_sock:客户端连接套接字</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    files_infos, compress = get_file_infos(client_sock)  <span class="comment"># 获取客户端传送的文件列表信息以及是否发送压缩文件</span></span><br><span class="line">    <span class="keyword">for</span> file_size, file_path_rel <span class="keyword">in</span> files_infos:  <span class="comment"># 逐个接收文件</span></span><br><span class="line">        res = recv_file(client_sock, file_path_rel, file_size, compress)</span><br><span class="line">        send_echo(client_sock, res)</span><br><span class="line">    client_sock.close()  <span class="comment"># 关闭客户端套接字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    启动服务后运行的线程函数</span></span><br><span class="line"><span class="string">    :param host: 服务器IP地址</span></span><br><span class="line"><span class="string">    :param port: 服务器端口号</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(DEFAULT_BAK_PATH):  <span class="comment"># 判断本地备份根目录是否存在</span></span><br><span class="line">        os.mkdir(DEFAULT_BAK_PATH)</span><br><span class="line">    server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 创建流失套接字</span></span><br><span class="line">    server_sock.settimeout(<span class="number">1</span>)  <span class="comment"># 设置超时时间1s</span></span><br><span class="line">    server_sock.bind((host, int(port)))  <span class="comment"># 绑定服务器端的IP和端口号</span></span><br><span class="line">    server_sock.listen(<span class="number">1</span>)  <span class="comment"># 同一时间只处理一个客户端的连接</span></span><br><span class="line">    flag_lock.acquire()  <span class="comment"># 访问SERV_RUN_FLAG之前需要先获取指令锁</span></span><br><span class="line">    <span class="keyword">while</span> SERV_RUN_FLAG:</span><br><span class="line">        flag_lock.release()  <span class="comment"># 访问完成后立马释放指令锁</span></span><br><span class="line">        client_sock = <span class="keyword">None</span>  <span class="comment"># 客户端连接的套接字</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            client_sock, addr_info = server_sock.accept()  <span class="comment"># 1s内没有发生客户端连接动作就会产生超时异常</span></span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> client_sock:  <span class="comment"># 确实有客户端发起连接请求</span></span><br><span class="line">            t = threading.Thread(target=client_operate, args=(client_sock,))  <span class="comment"># 单独开线程处理客户端的需求</span></span><br><span class="line">            t.start()</span><br><span class="line">        flag_lock.acquire()  <span class="comment"># 访问SERV_RUN_FLAG之前需要先获取指令锁</span></span><br><span class="line">    server_sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span><span class="params">(Frame)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义Frame</span></span><br><span class="line"><span class="string">        :param root: 父类容器对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        super().__init__(root)</span><br><span class="line">        self.root = root</span><br><span class="line">        self.grid()  <span class="comment"># 网格布局</span></span><br><span class="line">        self.local_ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">        self.local_ports = [<span class="number">10888</span>, <span class="number">20888</span>, <span class="number">30888</span>]</span><br><span class="line">        self.serv_ip = <span class="keyword">None</span></span><br><span class="line">        self.serv_port = <span class="keyword">None</span></span><br><span class="line">        self.__init_components()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_components</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化界面组件</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        proj_name = Label(self, text=<span class="string">u"远程备份服务器"</span>)</span><br><span class="line">        proj_name.grid(columnspan=<span class="number">2</span>)  <span class="comment"># 横跨两列</span></span><br><span class="line"></span><br><span class="line">        serv_ip_label = Label(self, text=<span class="string">u"服务地址"</span>)</span><br><span class="line">        serv_ip_label.grid(row=<span class="number">1</span>)</span><br><span class="line">        self.serv_ip = Combobox(self, values=self.__get_ip_address())  <span class="comment"># 下拉列表</span></span><br><span class="line">        self.serv_ip.set(self.local_ip)  <span class="comment"># 下拉列表默认值</span></span><br><span class="line">        self.serv_ip.grid(row=<span class="number">1</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        serv_port_label = Label(self, text=<span class="string">u"服务端口"</span>)</span><br><span class="line">        serv_port_label.grid(row=<span class="number">2</span>)</span><br><span class="line">        self.serv_port = Combobox(self, values=self.local_ports)</span><br><span class="line">        self.serv_port.set(self.local_ports[<span class="number">0</span>])</span><br><span class="line">        self.serv_port.grid(row=<span class="number">2</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.start_serv_btn = Button(self, text=<span class="string">u"启动服务"</span>, command=self.__start_serv)</span><br><span class="line">        self.start_serv_btn.grid(row=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        self.exit_serv_btn = Button(self, text=<span class="string">u"退出服务"</span>, command=self.__exit_serv)</span><br><span class="line">        self.exit_serv_btn.grid(row=<span class="number">3</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_ip_address</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取服务器端可用的IP地址</span></span><br><span class="line"><span class="string">        :return: IP地址列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        hostname = socket.gethostname()  <span class="comment"># 获取主机名</span></span><br><span class="line">        info = socket.gethostbyname_ex(hostname)  <span class="comment"># 根据主机名获取IP地址信息</span></span><br><span class="line">        info = info[<span class="number">2</span>]  <span class="comment"># 第3项才是ip地址列表</span></span><br><span class="line">        info.append(self.local_ip)  <span class="comment"># 加上回环地址</span></span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__start_serv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【启动服务】按键处理程序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        host = self.serv_ip.get()  <span class="comment"># 从下拉列表中获取用户设置的IP地址</span></span><br><span class="line">        port = self.serv_port.get()  <span class="comment"># 从下拉列表中获取用户设置的端口号</span></span><br><span class="line">        t = threading.Thread(target=start, args=(host, port))  <span class="comment"># 开启线程处理客户端连接请求</span></span><br><span class="line">        t.start()</span><br><span class="line">        self.start_serv_btn.state([<span class="string">"disabled"</span>, ])  <span class="comment"># 启动按钮变暗</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit_serv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【退出服务】按键处理程序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">global</span> SERV_RUN_FLAG</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">if</span> flag_lock.acquire():</span><br><span class="line">                SERV_RUN_FLAG = <span class="keyword">False</span></span><br><span class="line">                flag_lock.release()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        self.root.destroy()  <span class="comment"># 退出界面</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    root = Tk()</span><br><span class="line">    root.title(<span class="string">u"备份服务器"</span>)</span><br><span class="line">    root.resizable(<span class="keyword">False</span>, <span class="keyword">False</span>)</span><br><span class="line">    app = MyFrame(root)</span><br><span class="line">    app.mainloop()</span><br></pre></td></tr></table></figure>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter.ttk <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_file_infos</span><span class="params">(client, file_infos, compress)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    发送文件信息</span></span><br><span class="line"><span class="string">    :param client:客户端连接套接字</span></span><br><span class="line"><span class="string">    :param file_infos: 文件信息，列表</span></span><br><span class="line"><span class="string">    :param compress: 是否需要压缩</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    fmt_str = <span class="string">'Q?'</span>  <span class="comment"># 长整型+布尔类型</span></span><br><span class="line">    infos_bytes = pickle.dumps(file_infos)  <span class="comment"># 对file_infos序列化操作</span></span><br><span class="line">    infos_bytes_len = len(infos_bytes)</span><br><span class="line">    infos_bytes_len_pack = struct.pack(fmt_str, infos_bytes_len, compress)  <span class="comment"># 用struct模块对长度值进行二进制编码</span></span><br><span class="line">    client.sendall(infos_bytes_len_pack)  <span class="comment"># 先发送长度</span></span><br><span class="line">    client.sendall(infos_bytes)  <span class="comment"># 再发送内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_file</span><span class="params">(client, file, compress)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    发送单个文件至服务器</span></span><br><span class="line"><span class="string">    :param client:客户端连接套接字</span></span><br><span class="line"><span class="string">    :param file:#要发送文件的绝对路径</span></span><br><span class="line"><span class="string">    :param compress:是否需要压缩</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> compress:</span><br><span class="line">        f = open(file, <span class="string">"rb"</span>)  <span class="comment"># 二进制只读方式读取文件</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        f = tempfile.NamedTemporaryFile()  <span class="comment"># 创建临时文件</span></span><br><span class="line">        tar = tarfile.open(mode=<span class="string">"w:gz"</span>, fileobj=f)  <span class="comment"># gzip 压缩</span></span><br><span class="line">        tar.add(file)</span><br><span class="line">        tar.close()</span><br><span class="line">        f.seek(<span class="number">0</span>)  <span class="comment"># 调整文件指针位置</span></span><br><span class="line">        file_size = os.stat(f.name).st_size  <span class="comment"># 计算压缩文件的大小</span></span><br><span class="line">        file_size_pack = struct.pack(<span class="string">'Q'</span>, file_size)  <span class="comment"># 压缩文件大小二进制编码</span></span><br><span class="line">        client.sendall(file_size_pack)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            data = f.read(<span class="number">1024</span>)  <span class="comment"># 每次发送1K字节，直到发送结束</span></span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                client.sendall(data)  <span class="comment"># 发送原文件或者时压缩文件</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bak_info</span><span class="params">(client, size=<span class="number">7</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    从服务器获取当前备份结果信息</span></span><br><span class="line"><span class="string">    :param client:客户端连接套接字</span></span><br><span class="line"><span class="string">    :param size:返回结果信息[success,failure]的字节数</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    msg = client.recv(size)</span><br><span class="line">    print(msg.decode(<span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file_infos_paths</span><span class="params">(root_path)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    获取文件夹下的所有文件信息和文件路径</span></span><br><span class="line"><span class="string">    :param root_path:文件夹根目录</span></span><br><span class="line"><span class="string">    :return:infos文件信息列表，元素是元祖(文件大小，文件相对路径)，paths文件绝对路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    infos = []</span><br><span class="line">    paths = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root_path <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(root_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span>, <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">for</span> dirpath, dirnames, filenames <span class="keyword">in</span> os.walk(root_path):  <span class="comment"># 递归遍历根目录下所有文件</span></span><br><span class="line">        <span class="comment"># dirpath根目录，dirnames文件夹名，filenames文件名</span></span><br><span class="line">        <span class="keyword">for</span> file_name <span class="keyword">in</span> filenames:</span><br><span class="line">            file_path = os.path.join(dirpath, file_name)  <span class="comment"># 获取文件的绝对路径</span></span><br><span class="line">            paths.append(file_path)</span><br><span class="line">            file_size = os.stat(file_path).st_size  <span class="comment"># 获取文件大小</span></span><br><span class="line">            file_path_rel = file_path[len(root_path) + <span class="number">1</span>:]  <span class="comment"># 获取文件相对路径</span></span><br><span class="line">            infos.append((file_size, file_path_rel))</span><br><span class="line">    <span class="keyword">return</span> infos, paths</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(host, port, root_path, compress)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    开始备份工作的线程函数</span></span><br><span class="line"><span class="string">    :param host:服务器IP地址</span></span><br><span class="line"><span class="string">    :param port:服务器端口号</span></span><br><span class="line"><span class="string">    :param root_path:备份路径根目录</span></span><br><span class="line"><span class="string">    :param compress:是否需要压缩文件</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(root_path):</span><br><span class="line">        print(<span class="string">u"备份的路径不存在!"</span>, root_path)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    client_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 建立流式套接字</span></span><br><span class="line">    client_sock.connect((host, port))  <span class="comment"># 连接服务器</span></span><br><span class="line">    file_infos, file_paths = get_file_infos_paths(root_path)  <span class="comment"># 获取指定目录下的文件信息与文件路径</span></span><br><span class="line">    send_file_infos(client_sock, file_infos, compress)  <span class="comment"># 发送需要备份的文件信息</span></span><br><span class="line">    <span class="keyword">for</span> fp <span class="keyword">in</span> file_paths:</span><br><span class="line">        send_file(client_sock, fp, compress)  <span class="comment"># 依次发送所有文件</span></span><br><span class="line">        print(fp)  <span class="comment"># 打印当前正在备份的文件</span></span><br><span class="line">        get_bak_info(client_sock)  <span class="comment"># 打印文件备份结果</span></span><br><span class="line">    client_sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span><span class="params">(Frame)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义Frame</span></span><br><span class="line"><span class="string">        :param root: 父类容器对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        super().__init__(root)</span><br><span class="line">        self.root = root  <span class="comment"># 保存父类容器控件</span></span><br><span class="line">        self.grid()  <span class="comment"># 整体使用网格布局</span></span><br><span class="line">        self.remote_ip_default = <span class="string">"127.0.0.1"</span>  <span class="comment"># 默认连接的服务器IP地址</span></span><br><span class="line">        self.remote_port_default = <span class="number">10888</span>  <span class="comment"># 默认连接的服务器端口号</span></span><br><span class="line">        self.remote_ip_var = StringVar()  <span class="comment"># 保存用户输入的服务器IP地址</span></span><br><span class="line">        self.remote_port_var = IntVar()  <span class="comment"># 保存用户输入的服务器端口号</span></span><br><span class="line">        self.bak_src_var = StringVar()  <span class="comment"># 保存用户输入的本地备份路径</span></span><br><span class="line">        self.compress_var = BooleanVar()  <span class="comment"># 保存用户是否需要对文件进行压缩处理</span></span><br><span class="line">        self.__init_components()  <span class="comment"># 初始化界面上的所有组件</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_components</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化界面组件</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        proj_name = Label(self, text=<span class="string">u"远程备份客户端"</span>)</span><br><span class="line">        proj_name.grid(columnspan=<span class="number">2</span>)  <span class="comment"># 横跨两列</span></span><br><span class="line"></span><br><span class="line">        serv_ip_label = Label(self, text=<span class="string">u"服务器地址："</span>)</span><br><span class="line">        serv_ip_label.grid(row=<span class="number">1</span>)</span><br><span class="line">        self.serv_ip = Entry(self, textvariable=self.remote_ip_var)  <span class="comment"># 输入框</span></span><br><span class="line">        self.remote_ip_var.set(self.remote_ip_default)</span><br><span class="line">        self.serv_ip.grid(row=<span class="number">1</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        serv_port_label = Label(self, text=<span class="string">u"服务器端口："</span>)</span><br><span class="line">        serv_port_label.grid(row=<span class="number">2</span>)</span><br><span class="line">        self.serv_port = Entry(self, textvariable=self.remote_port_var)</span><br><span class="line">        self.remote_port_var.set(self.remote_port_default)</span><br><span class="line">        self.serv_port.grid(row=<span class="number">2</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        bak_src_label = Label(self, text=<span class="string">u"备份的目标："</span>)</span><br><span class="line">        bak_src_label.grid(row=<span class="number">3</span>)</span><br><span class="line">        self.bak_src = Entry(self, textvariable=self.bak_src_var)</span><br><span class="line">        self.bak_src.grid(row=<span class="number">3</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        compress_label = Label(self, text=<span class="string">u"压缩备份："</span>)</span><br><span class="line">        compress_label.grid(row=<span class="number">4</span>)</span><br><span class="line">        self.compress_on = Checkbutton(self, text=<span class="string">u"开启压缩"</span>, variable=self.compress_var, onvalue=<span class="number">1</span>, offvalue=<span class="number">0</span>)  <span class="comment"># 单选框</span></span><br><span class="line">        self.compress_on.grid(row=<span class="number">4</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.start_serv_btn = Button(self, text=<span class="string">u"开始备份"</span>, command=self.__start_bak)  <span class="comment"># 按钮，绑定事件处理函数</span></span><br><span class="line">        self.start_serv_btn.grid(row=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        self.exit_serv_btn = Button(self, text=<span class="string">u"退出程序"</span>, command=self.__exit_bak)</span><br><span class="line">        self.exit_serv_btn.grid(row=<span class="number">5</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__start_bak</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【开始备份】事件处理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        host = self.remote_ip_var.get()</span><br><span class="line">        port = self.remote_port_var.get()</span><br><span class="line">        bak_path = self.bak_src_var.get()</span><br><span class="line">        compress = self.compress_var.get()</span><br><span class="line">        self.bak_src_var.set(<span class="string">""</span>)  <span class="comment"># 清空备份路径输入框</span></span><br><span class="line">        t = threading.Thread(target=start, args=(host, port, bak_path, compress))  <span class="comment"># 创建子线程</span></span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit_bak</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【退出程序】事件处理</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.root.destroy()  <span class="comment"># 退出界面</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    root = Tk()</span><br><span class="line">    root.title(<span class="string">u"备份客户端"</span>)</span><br><span class="line">    root.resizable(<span class="keyword">False</span>, <span class="keyword">False</span>)  <span class="comment"># 大小不允许伸缩</span></span><br><span class="line">    app = MyFrame(root)</span><br><span class="line">    app.mainloop()</span><br></pre></td></tr></table></figure>
<h2 id="SocketServer框架"><a href="#SocketServer框架" class="headerlink" title="SocketServer框架"></a>SocketServer框架</h2><blockquote>
<p>Python提供了SocketServer框架用来编写网络服务器，它预定义了一个基本的服务器框架</p>
<p>步骤：</p>
<ol>
<li>建立客户端处理类</li>
<li>初始化服务器类，传入相关参数</li>
<li>启动服务器</li>
</ol>
</blockquote>
<h3 id="SocketServer框架下的TCP服务器"><a href="#SocketServer框架下的TCP服务器" class="headerlink" title="SocketServer框架下的TCP服务器"></a>SocketServer框架下的TCP服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"127.0.0.1"</span></span><br><span class="line">PORT = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shut_server_down</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> server:</span><br><span class="line">        server.shutdown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span><span class="params">(socketserver.StreamRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            data = self.rfile.readline()  <span class="comment"># 按行读取数据(需要数据中包含换行符)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(<span class="string">"Receive From Client: "</span>, data.decode(<span class="string">"utf-8"</span>).strip(<span class="string">'\n'</span>))</span><br><span class="line">            self.wfile.write(data)</span><br><span class="line">        threading.Thread(target=shut_server_down).start()  <span class="comment"># 服务器的shutdown方法需要在别的线程中调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    server = socketserver.TCPServer((HOST, PORT), MyHandler)  <span class="comment"># 创建TCP服务器</span></span><br><span class="line">    server.serve_forever()  <span class="comment"># 运行服务器</span></span><br></pre></td></tr></table></figure>
<h4 id="配套的TCP客户端"><a href="#配套的TCP客户端" class="headerlink" title="配套的TCP客户端"></a>配套的TCP客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.104"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    client_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment"># 本套接字是建立在IPv4基础上的流式套接字</span></span><br><span class="line">    client_sock.connect((server_host, server_port))  <span class="comment"># 向服务器发起连接</span></span><br><span class="line">    data = <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">while</span> data:</span><br><span class="line">        data = input(<span class="string">"Please Enter a Message to Send: "</span>)</span><br><span class="line">        data += <span class="string">'\n'</span></span><br><span class="line">        client_sock.send(data.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">        data = client_sock.recv(<span class="number">1024</span>)</span><br><span class="line">        data = data.decode(<span class="string">"utf-8"</span>).strip(<span class="string">'\n'</span>)</span><br><span class="line">        print(<span class="string">"Receive from Server: &#123;content&#125;"</span>.format(content=data))</span><br><span class="line">    client_sock.close()</span><br></pre></td></tr></table></figure>
<h3 id="SocketServer框架下的UDP服务器"><a href="#SocketServer框架下的UDP服务器" class="headerlink" title="SocketServer框架下的UDP服务器"></a>SocketServer框架下的UDP服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"192.168.1.104"</span></span><br><span class="line">PORT = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shut_server_down</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> server:</span><br><span class="line">        server.shutdown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span><span class="params">(socketserver.DatagramRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        data, client_sock = self.request</span><br><span class="line">        data = data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">            threading.Thread(target=shut_server_down).start()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        print(<span class="string">"Receive From Client: "</span>, data)</span><br><span class="line">        data = data + <span class="string">"---&gt;OK"</span></span><br><span class="line">        client_sock.sendto(data.encode(<span class="string">"utf-8"</span>), self.client_address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    server = socketserver.UDPServer((HOST, PORT), MyHandler)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>
<h4 id="配套的UDP客户端"><a href="#配套的UDP客户端" class="headerlink" title="配套的UDP客户端"></a>配套的UDP客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_host = <span class="string">"192.168.1.104"</span></span><br><span class="line">server_port = <span class="number">3629</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    client_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)  <span class="comment"># 本套接字是建立在IPv4基础上的数据报套接字</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = input(<span class="string">"Please Enter a Message to Send: "</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            client_sock.sendto(data.encode(<span class="string">"utf-8"</span>), (server_host, server_port))</span><br><span class="line">            <span class="keyword">if</span> data == <span class="string">"bye"</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data = <span class="string">b""</span></span><br><span class="line">            <span class="keyword">while</span> len(data) == <span class="number">0</span>:  <span class="comment"># 防止接收到空数据</span></span><br><span class="line">                data, server_addr_info = client_sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">            data = data.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">            print(<span class="string">"Receive from Server[&#123;addr_info&#125;]:&#123;content&#125;"</span>.format(addr_info=server_addr_info, content=data))</span><br><span class="line">    client_sock.close()</span><br></pre></td></tr></table></figure>
<h2 id="使用SocketServer框架改写备份服务器程序"><a href="#使用SocketServer框架改写备份服务器程序" class="headerlink" title="使用SocketServer框架改写备份服务器程序"></a>使用SocketServer框架改写备份服务器程序</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter.ttk <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEFAULT_BAK_PATH = <span class="string">r"E:\MyBak"</span>  <span class="comment"># 服务器端默认备份路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mk_file_path</span><span class="params">(filepath_rel)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据文件的相对路径创建服务器端的路径</span></span><br><span class="line"><span class="string">    :param filepath_rel: 客户端文件的相对路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    paths = filepath_rel.split(os.path.sep)[:<span class="number">-1</span>]  <span class="comment"># 按照目录级别切分，去掉最后一项(文件名)</span></span><br><span class="line">    p = DEFAULT_BAK_PATH</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> paths:</span><br><span class="line">        p = os.path.join(p, path)  <span class="comment"># 逐级创建文件夹</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(p):</span><br><span class="line">            os.mkdir(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BakHandler</span><span class="params">(socketserver.StreamRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__client_operate()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__client_operate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端处理线程</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        files_infos, compress = self.__get_file_infos()  <span class="comment"># 获取客户端传送的文件列表信息以及是否发送压缩文件</span></span><br><span class="line">        <span class="keyword">for</span> file_size, file_path_rel <span class="keyword">in</span> files_infos:  <span class="comment"># 逐个接收文件</span></span><br><span class="line">            res = self.__recv_file(file_path_rel, file_size, compress)  <span class="comment"># request就是客户端连接的套接字</span></span><br><span class="line">            self.__send_echo(res)</span><br><span class="line">            self.request.close()  <span class="comment"># 关闭客户端套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_file_infos</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        接受客户端传来的文件列表信息</span></span><br><span class="line"><span class="string">        :return:data要备份的文件列表信息，compress是否是压缩文件</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        fmt_str = <span class="string">'Q?'</span>  <span class="comment"># 长整形+布尔型</span></span><br><span class="line">        headsize = struct.calcsize(fmt_str)</span><br><span class="line">        data = self.request.recv(headsize)  <span class="comment"># 接受文件信息列表的长度</span></span><br><span class="line">        infos_len, compress = struct.unpack(fmt_str, data)  <span class="comment"># unpack字节数据</span></span><br><span class="line">        data = <span class="string">b""</span>  <span class="comment"># 保存文件列表信息</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:  <span class="comment"># 每次最多接收1K字节</span></span><br><span class="line">            <span class="keyword">if</span> infos_len &gt; <span class="number">1024</span>:</span><br><span class="line">                data += self.request.recv(<span class="number">1024</span>)</span><br><span class="line">                infos_len -= <span class="number">1024</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                data += self.request.recv(infos_len)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        data = pickle.loads(data)  <span class="comment"># 使用pickle反序列化</span></span><br><span class="line">        <span class="keyword">return</span> data, compress</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__send_echo</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        发送当前文件的备份结果给客户端</span></span><br><span class="line"><span class="string">        :param result: 当前文件备份的结果</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            self.request.send(<span class="string">b"success"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.request.send(<span class="string">b"failure"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__recv_file</span><span class="params">(self, filepath_rel, file_size, compress)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        接收并保存单个文件</span></span><br><span class="line"><span class="string">        :param filepath_rel:文件的相对地址</span></span><br><span class="line"><span class="string">        :param file_size:文件大小</span></span><br><span class="line"><span class="string">        :param compress:是否是压缩文件</span></span><br><span class="line"><span class="string">        :return:返回接收成功与否</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = <span class="keyword">True</span></span><br><span class="line">        mk_file_path(filepath_rel)</span><br><span class="line">        filepath = os.path.join(DEFAULT_BAK_PATH, filepath_rel)  <span class="comment"># 文件在服务器端的完整路径</span></span><br><span class="line">        <span class="keyword">if</span> compress:</span><br><span class="line">            file_size = self.__get_compress_size()</span><br><span class="line">            filepath = <span class="string">""</span>.join([os.path.splitext(filepath)[<span class="number">0</span>], <span class="string">".tar.gz"</span>])  <span class="comment"># 修改文件拓展名</span></span><br><span class="line">        f = open(filepath, <span class="string">"wb+"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">                <span class="keyword">if</span> file_size &gt; <span class="number">1024</span>:</span><br><span class="line">                    data = self.request.recv(<span class="number">1024</span>)</span><br><span class="line">                    f.write(data)</span><br><span class="line">                    file_size -= <span class="number">1024</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    data = self.request.recv(file_size)</span><br><span class="line">                    f.write(data)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">            res = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            f.close()</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_compress_size</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取压缩文件的大小</span></span><br><span class="line"><span class="string">        :return: size压缩文件的大小</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        fmt_str = <span class="string">'Q'</span>  <span class="comment"># 长整型</span></span><br><span class="line">        size = struct.calcsize(fmt_str)</span><br><span class="line">        data = self.request.recv(size)</span><br><span class="line">        size = struct.unpack(fmt_str, data)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span><span class="params">(Frame)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义Frame</span></span><br><span class="line"><span class="string">        :param root: 父类容器对象(根窗口)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        super().__init__(root)</span><br><span class="line">        self.root = root</span><br><span class="line">        self.server = <span class="keyword">None</span></span><br><span class="line">        self.grid()  <span class="comment"># 网格布局</span></span><br><span class="line">        self.local_ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">        self.local_ports = [<span class="number">10888</span>, <span class="number">20888</span>, <span class="number">30888</span>]</span><br><span class="line">        self.serv_ip = <span class="keyword">None</span></span><br><span class="line">        self.serv_port = <span class="keyword">None</span></span><br><span class="line">        self.__init_components()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_components</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化界面组件</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        proj_name = Label(self, text=<span class="string">u"远程备份服务器"</span>)</span><br><span class="line">        proj_name.grid(columnspan=<span class="number">2</span>)  <span class="comment"># 横跨两列</span></span><br><span class="line"></span><br><span class="line">        serv_ip_label = Label(self, text=<span class="string">u"服务地址"</span>)</span><br><span class="line">        serv_ip_label.grid(row=<span class="number">1</span>)</span><br><span class="line">        self.serv_ip = Combobox(self, values=self.__get_ip_address())  <span class="comment"># 下拉列表</span></span><br><span class="line">        self.serv_ip.set(self.local_ip)  <span class="comment"># 下拉列表默认值</span></span><br><span class="line">        self.serv_ip.grid(row=<span class="number">1</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        serv_port_label = Label(self, text=<span class="string">u"服务端口"</span>)</span><br><span class="line">        serv_port_label.grid(row=<span class="number">2</span>)</span><br><span class="line">        self.serv_port = Combobox(self, values=self.local_ports)</span><br><span class="line">        self.serv_port.set(self.local_ports[<span class="number">0</span>])</span><br><span class="line">        self.serv_port.grid(row=<span class="number">2</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.start_serv_btn = Button(self, text=<span class="string">u"启动服务"</span>, command=self.__start_serv)</span><br><span class="line">        self.start_serv_btn.grid(row=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        self.exit_serv_btn = Button(self, text=<span class="string">u"退出服务"</span>, command=self.__exit_serv)</span><br><span class="line">        self.exit_serv_btn.grid(row=<span class="number">3</span>, column=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_ip_address</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取服务器端可用的IP地址</span></span><br><span class="line"><span class="string">        :return: IP地址列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        hostname = socket.gethostname()  <span class="comment"># 获取主机名</span></span><br><span class="line">        info = socket.gethostbyname_ex(hostname)  <span class="comment"># 根据主机名获取IP地址信息</span></span><br><span class="line">        info = info[<span class="number">2</span>]  <span class="comment"># 第3项才是ip地址列表</span></span><br><span class="line">        info.append(self.local_ip)  <span class="comment"># 加上回环地址</span></span><br><span class="line">        <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__start_serv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【启动服务】按键处理程序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(DEFAULT_BAK_PATH):  <span class="comment"># 判断本地备份根目录是否存在</span></span><br><span class="line">            os.mkdir(DEFAULT_BAK_PATH)</span><br><span class="line">        host = self.serv_ip.get()  <span class="comment"># 从下拉列表中获取用户设置的IP地址</span></span><br><span class="line">        port = self.serv_port.get()  <span class="comment"># 从下拉列表中获取用户设置的端口号</span></span><br><span class="line">        self.start_serv_btn.state([<span class="string">"disabled"</span>, ])  <span class="comment"># 启动按钮变暗</span></span><br><span class="line">        self.server = socketserver.ThreadingTCPServer((host, int(port)), BakHandler)  <span class="comment"># 创建多线程TCP服务器</span></span><br><span class="line">        threading.Thread(target=self.server.serve_forever).start()  <span class="comment"># 在新线程中启动服务器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit_serv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        【退出服务】按键处理程序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.server:</span><br><span class="line">            threading.Thread(target=self.server.shutdown).start()</span><br><span class="line">        self.root.destroy()  <span class="comment"># 退出界面</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    root = Tk()  <span class="comment"># 根窗口</span></span><br><span class="line">    root.title(<span class="string">u"备份服务器"</span>)</span><br><span class="line">    root.resizable(<span class="keyword">False</span>, <span class="keyword">False</span>)</span><br><span class="line">    app = MyFrame(root)</span><br><span class="line">    app.mainloop()</span><br></pre></td></tr></table></figure>
<h2 id="项目：简单FTP服务器与客户端的实现"><a href="#项目：简单FTP服务器与客户端的实现" class="headerlink" title="项目：简单FTP服务器与客户端的实现"></a>项目：简单FTP服务器与客户端的实现</h2><h3 id="FTP服务器的实现"><a href="#FTP服务器的实现" class="headerlink" title="FTP服务器的实现"></a>FTP服务器的实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_opr_file</span><span class="params">(client_addr, item)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    向FTPDataHandler类的操作列表中添加新操作</span></span><br><span class="line"><span class="string">    命令通道和数据通道，实际上是通过FTPDataHandler类中的client_oper字典联系在一起的</span></span><br><span class="line"><span class="string">    :param client_addr: 客户端的ip地址</span></span><br><span class="line"><span class="string">    :param item: 新操作</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> client_addr <span class="keyword">in</span> FTPDataHandler.client_oper:</span><br><span class="line">        FTPDataHandler.client_oper[client_addr].append(item)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        FTPDataHandler.client_oper[client_addr] = [item, ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTPHandler</span><span class="params">(socketserver.StreamRequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request=None, client_addr=None, server=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        FTP服务器的处理类</span></span><br><span class="line"><span class="string">        :param request: 请求对象，即连接的客户端socket</span></span><br><span class="line"><span class="string">        :param client_addr: 客户端地址</span></span><br><span class="line"><span class="string">        :param server: 与自己绑定的服务器对象(即后面的MyThreadFTPServer对象)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.cmd_keys = (<span class="string">"QUIT"</span>, <span class="string">"USER"</span>, <span class="string">"NOOP"</span>, <span class="string">"TYPE"</span>, <span class="string">"PASV"</span>, <span class="string">"PORT"</span>, <span class="string">"RETR"</span>, <span class="string">"STOR"</span>)  <span class="comment"># FTP服务器支持的命令</span></span><br><span class="line">        self.coms = &#123;&#125;  <span class="comment"># 字典，&#123;命令:执行方法&#125;</span></span><br><span class="line">        self.__init_coms()  <span class="comment"># 初始化字典coms</span></span><br><span class="line">        self.server = server  <span class="comment"># 与服务类绑定的服务器的引用</span></span><br><span class="line">        self.cmd_port = <span class="number">21</span>  <span class="comment"># 命令端口号</span></span><br><span class="line">        self.data_port = <span class="number">20</span>  <span class="comment"># 数据端口号</span></span><br><span class="line">        self.pasv_data_ip = <span class="keyword">None</span>  <span class="comment"># 被动模式下，数据模块线程服务器的IP地址</span></span><br><span class="line">        self.pasv_data_port = <span class="keyword">None</span>  <span class="comment"># 被动模式下，数据模块线程服务器的端口号</span></span><br><span class="line">        self.args = <span class="keyword">None</span>  <span class="comment"># 某条命令对应的参数</span></span><br><span class="line">        self.loged = <span class="keyword">False</span>  <span class="comment"># 用户是否登陆</span></span><br><span class="line">        self.pasv_mode = <span class="keyword">None</span>  <span class="comment"># 当前服务器是否工作在被动模式</span></span><br><span class="line">        super().__init__(request, client_addr, server)  <span class="comment"># 调用父类的构造函数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_coms</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化字典coms，键为命令名字，值为具体的方法</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> self.cmd_keys:</span><br><span class="line">            self.coms[key] = getattr(self, <span class="string">"exe_"</span> + key.lower())  <span class="comment"># 获取exe_开头的成员方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        重写父类的处理函数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmds = self.rfile.readline()  <span class="comment"># 读取一行用户发来的命令</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cmds:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            cmds = cmds.decode(<span class="string">"utf-8"</span>)  <span class="comment"># 解码</span></span><br><span class="line">            cmd = self.__parse_cmd(cmds)  <span class="comment"># 解析命令</span></span><br><span class="line">            <span class="keyword">if</span> cmd <span class="keyword">in</span> self.cmd_keys:</span><br><span class="line">                self.coms[cmd]()  <span class="comment"># 执行命令对应的方法</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.__send(<span class="number">500</span>, <span class="string">"Invalid command."</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd == <span class="string">"QUIT"</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse_cmd</span><span class="params">(self, cmds)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        从字符串中提取命令动词和参数</span></span><br><span class="line"><span class="string">        :param cmds:包含命令、参数的字符串</span></span><br><span class="line"><span class="string">        :return:命令动词，大写</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">' '</span> <span class="keyword">in</span> cmds:  <span class="comment"># 根据空格来判断是否包含命令参数</span></span><br><span class="line">            cmd, args = cmds.split(<span class="string">' '</span>)  <span class="comment"># 切分命令动词与命令参数</span></span><br><span class="line">            self.args = args.strip(<span class="string">'\n'</span>).strip()  <span class="comment"># 清除换行符与空格</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cmd = cmds.strip(<span class="string">'\n'</span>).strip()</span><br><span class="line">        <span class="keyword">return</span> cmd.upper()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__send</span><span class="params">(self, code, info)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        向客户端返回命令执行状态</span></span><br><span class="line"><span class="string">        :param code:状态码</span></span><br><span class="line"><span class="string">        :param info:状态信息</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        infos = <span class="string">"%d %s\n"</span> % (code, info)</span><br><span class="line">        self.request.sendall(infos.encode(<span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__make_pasv_info</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        返回进入主动模式的信息</span></span><br><span class="line"><span class="string">        :return: 返回给客户端的信息，包括主动模式数据通道的IP地址和端口号，按照FTP协议的格式要求发送</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ip_info = self.pasv_data_ip.split(<span class="string">'.'</span>)  <span class="comment"># IP地址之间的.号使用,号来替代</span></span><br><span class="line">        ip_info = <span class="string">','</span>.join(ip_info)</span><br><span class="line">        porta_info = str(self.pasv_data_port // <span class="number">256</span>)</span><br><span class="line">        portb_info = str(self.pasv_data_port % <span class="number">256</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">','</span>.join((ip_info, porta_info, portb_info))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter_pasv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        进入被动模式，开启数据服务器</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.server.data_server:</span><br><span class="line">            self.pasv_data_ip, self.pasv_data_port = self.server.create_data_server()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_quit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        QUIT命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.__send(<span class="number">221</span>, <span class="string">"bye."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_user</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        USER命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        user = self.args  <span class="comment"># 获取登陆的用户名</span></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">in</span> (<span class="string">""</span>, <span class="string">"anonymous"</span>):</span><br><span class="line">            self.loged = <span class="keyword">True</span></span><br><span class="line">            self.__send(<span class="number">230</span>, <span class="string">"identified!"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.__send(<span class="number">530</span>, <span class="string">"Only use anonymous."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_noop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        NOOP命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.__send(<span class="number">200</span>, <span class="string">"ok."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_type</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        TYPE命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.__send(<span class="number">200</span>, <span class="string">"ok."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_pasv</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        PASV命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.loged:</span><br><span class="line">            self.__send(<span class="number">332</span>, <span class="string">"Please login."</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.pasv_mode:  <span class="comment"># 已经passive模式了</span></span><br><span class="line">            info = <span class="string">"entering passive mode (%s)"</span> % self.__make_pasv_info()</span><br><span class="line">            self.__send(<span class="number">227</span>, info)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.__enter_pasv()  <span class="comment"># 进入passive模式</span></span><br><span class="line">            info = <span class="string">"entering passive mode (%s)"</span> % self.__make_pasv_info()</span><br><span class="line">            self.pasv_mode = <span class="keyword">True</span></span><br><span class="line">            self.__send(<span class="number">227</span>, info)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  <span class="comment"># 进入passive模式失败</span></span><br><span class="line">            print(e)</span><br><span class="line">            self.pasv_mode = <span class="keyword">False</span></span><br><span class="line">            self.__send(<span class="number">500</span>, <span class="string">"Fail to enter passvie mode."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_port</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        PORT命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.__send(<span class="number">500</span>, <span class="string">"Do not support port mode."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_retr</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        RETR命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(os.path.join(<span class="string">"/root"</span>, <span class="string">"server"</span>, self.args)):  <span class="comment"># 确保要下载的文件是存在的</span></span><br><span class="line">            self.__send(<span class="number">550</span>, <span class="string">"File &#123;file_path&#125; not exist!"</span>.format(file_path=self.args))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        client_addr = self.request.getpeername()[<span class="number">0</span>]  <span class="comment"># 获取客户端的IP地址</span></span><br><span class="line">        add_opr_file(client_addr, (<span class="string">"RETR"</span>, self.args))  <span class="comment"># 向数据通道中添加新的任务</span></span><br><span class="line">        self.__send(<span class="number">150</span>, <span class="string">"ok."</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exe_stor</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        STOR命令的执行动作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        client_addr = self.request.getpeername()[<span class="number">0</span>]</span><br><span class="line">        add_opr_file(client_addr, (<span class="string">"STOR"</span>, self.args))  <span class="comment"># 向数据通道中添加新的任务</span></span><br><span class="line">        self.__send(<span class="number">150</span>, <span class="string">"ok."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTPDataHandler</span><span class="params">(socketserver.StreamRequestHandler)</span>:</span></span><br><span class="line">    client_oper = &#123;&#125;  <span class="comment"># 字典，键为客户端IP地址，值为列表，存放具体的操作</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        数据服务器针对每个连接的客户端的操作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        peerip = self.request.getpeername()[<span class="number">0</span>]  <span class="comment"># 获取连接的客户端的IP地址</span></span><br><span class="line">        opr = self.__get_opr_args(peerip)  <span class="comment"># 根据IP地址查询该客户端具体的操作</span></span><br><span class="line">        <span class="keyword">if</span> opr:</span><br><span class="line">            <span class="keyword">if</span> opr[<span class="number">0</span>] == <span class="string">"RETR"</span>:</span><br><span class="line">                self.retr_file(opr[<span class="number">1</span>])  <span class="comment"># 下载文件</span></span><br><span class="line">            <span class="keyword">elif</span> opr[<span class="number">0</span>] == <span class="string">"STOR"</span>:</span><br><span class="line">                self.stor_file(opr[<span class="number">1</span>])  <span class="comment"># 上传文件</span></span><br><span class="line">        self.request.close()  <span class="comment"># 处理完依次上传或者下载任务后就关闭客户端套接字</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get_opr_args</span><span class="params">(self, peerip)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        根据IP地址查询客户端需要服务的内容</span></span><br><span class="line"><span class="string">        :param peerip: 远端的IP地址</span></span><br><span class="line"><span class="string">        :return: opr具体的操作</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> peerip <span class="keyword">in</span> self.client_oper:</span><br><span class="line">            opr = self.client_oper[peerip].pop(<span class="number">0</span>)  <span class="comment"># 弹出列表中的第一个</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.client_oper[peerip]:  <span class="comment"># 针对该IP地址，列表中没有其余操作了</span></span><br><span class="line">                self.client_oper.pop(peerip)  <span class="comment"># 在字段中删除这个IP地址为键的项目</span></span><br><span class="line">            <span class="keyword">return</span> opr</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retr_file</span><span class="params">(self, filepath)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端下载文件(对应服务器端的发送文件)</span></span><br><span class="line"><span class="string">        :param filepath: 文件路径</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        filepath = os.path.join(<span class="string">"/root"</span>, <span class="string">"server"</span>, filepath)</span><br><span class="line">        print(filepath)</span><br><span class="line">        f = open(filepath, <span class="string">"rb"</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            data = f.read(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                self.request.sendall(data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stor_file</span><span class="params">(self, filepath)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端上传文件(对应服务器端的接收并保存文件)</span></span><br><span class="line"><span class="string">        :param filepath:文件路径</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        filepath = os.path.join(<span class="string">"/root"</span>, <span class="string">"server"</span>, filepath)</span><br><span class="line">        print(filepath)</span><br><span class="line">        f = open(filepath, <span class="string">"wb"</span>)  <span class="comment"># 将新文件保存到当前目录的bakt文件夹下</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            data = self.request.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                f.write(data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadFTPServer</span><span class="params">(socketserver.ThreadingTCPServer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, addr, handler)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义多线程FTP服务器</span></span><br><span class="line"><span class="string">        :param addr: 服务器地址，元祖(IP地址，端口号)，21命令端口，20数据端口</span></span><br><span class="line"><span class="string">        :param handler:处理客户端连接的对象</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.data_server = <span class="keyword">None</span>  <span class="comment"># 专门负责数据通道的服务器</span></span><br><span class="line">        super().__init__(addr, handler)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shutdown</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        重写父类的shutdown函数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.data_server:  <span class="comment"># 是否有数据通道服务器没有关闭</span></span><br><span class="line">            threading.Thread(target=self.data_server.shutdown).start()</span><br><span class="line">        super().shutdown()  <span class="comment"># 调用父类的挂机函数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_data_server</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        创建数据通道专用服务器</span></span><br><span class="line"><span class="string">        :return:pasv_data_ip数据服务器的IP地址；pasv_data_port数据服务器的端口号</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.data_server = socketserver.ThreadingTCPServer((<span class="string">"127.0.0.1"</span>, <span class="number">0</span>), FTPDataHandler)</span><br><span class="line">        pasv_data_ip, pasv_data_port = self.data_server.server_address  <span class="comment"># 获取数据服务器的ip地址和端口号</span></span><br><span class="line">        threading.Thread(target=self.data_server.serve_forever).start()  <span class="comment"># 开启新线程，启动数据服务器</span></span><br><span class="line">        <span class="keyword">return</span> pasv_data_ip, pasv_data_port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ftp_server = MyThreadFTPServer((<span class="string">"127.0.0.1"</span>, <span class="number">21</span>), FTPHandler)</span><br><span class="line">    threading.Thread(target=ftp_server.serve_forever).start()  <span class="comment"># 开启新线程，启动FTP服务器</span></span><br><span class="line">    print(<span class="string">"FTP Server Start..."</span>)</span><br><span class="line">    <span class="comment"># time.sleep(30)</span></span><br><span class="line">    <span class="comment"># ftp_server.shutdown()</span></span><br></pre></td></tr></table></figure>
<h3 id="FTP客户端的实现"><a href="#FTP客户端的实现" class="headerlink" title="FTP客户端的实现"></a>FTP客户端的实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file</span><span class="params">(host, port, file_path)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    从服务器下载文件</span></span><br><span class="line"><span class="string">    :param host: 服务器IP地址</span></span><br><span class="line"><span class="string">    :param port: 服务器端口号</span></span><br><span class="line"><span class="string">    :param file_path: 文件路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    file_path = os.path.join(<span class="string">"/root"</span>, <span class="string">"client"</span>, file_path)  <span class="comment"># 文件保存在服务器的bakt文件夹下</span></span><br><span class="line">    print(file_path)</span><br><span class="line">    f = open(file_path, <span class="string">"wb"</span>)</span><br><span class="line">    data = <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">while</span> data:</span><br><span class="line">        data = s.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            f.write(data)</span><br><span class="line">    s.close()</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_data</span><span class="params">(host, port, file_path)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    上传文件至服务器</span></span><br><span class="line"><span class="string">    :param host: 服务器的IP地址</span></span><br><span class="line"><span class="string">    :param port: 服务器的端口号</span></span><br><span class="line"><span class="string">    :param file_path: 本地文件路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((host, port))</span><br><span class="line">    print(file_path)</span><br><span class="line">    f = open(file_path, <span class="string">"rb"</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = f.read(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            s.sendall(data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    s.close()</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTPClient</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=<span class="string">"localhost"</span>, port=<span class="number">21</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        自定义FTP客户端</span></span><br><span class="line"><span class="string">        :param host:服务器IP地址</span></span><br><span class="line"><span class="string">        :param port:服务器端口号</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.host = host  <span class="comment"># 服务器ip地址</span></span><br><span class="line">        self.port = port  <span class="comment"># 服务器端口号</span></span><br><span class="line">        self.cmds = (<span class="string">"QUIT"</span>, <span class="string">"USER"</span>, <span class="string">"NOOP"</span>, <span class="string">"TYPE"</span>, <span class="string">"PASV"</span>, <span class="string">"PORT"</span>, <span class="string">"RETR"</span>, <span class="string">"STOR"</span>)  <span class="comment"># 支持的FTP命令</span></span><br><span class="line">        self.line_sep = <span class="string">'\n'</span></span><br><span class="line">        self.loged = <span class="keyword">False</span>  <span class="comment"># 是否已经登陆服务器</span></span><br><span class="line">        self.sock = <span class="keyword">None</span>  <span class="comment"># 连接服务器端的套接字</span></span><br><span class="line">        self.pasv_mode = <span class="keyword">None</span>  <span class="comment"># 是否处于被动模式</span></span><br><span class="line">        self.pasv_host = <span class="keyword">None</span>  <span class="comment"># 被动模式的服务器ip地址</span></span><br><span class="line">        self.pasv_port = <span class="keyword">None</span>  <span class="comment"># 被动模式的服务器端口号</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__cmd_connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        连接服务器</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.connect((self.host, self.port))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__login</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        登录服务器</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.sock:</span><br><span class="line">            self.send_cmd(<span class="string">"USER"</span>)</span><br><span class="line">            res = self.read_line(self.sock)</span><br><span class="line">            <span class="keyword">if</span> res.startswith(<span class="string">"230"</span>):</span><br><span class="line">                print(<span class="string">"Log in Successfully!"</span>)</span><br><span class="line">                self.loged = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_line</span><span class="params">(self, sock)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        按行读取服务器返回数据</span></span><br><span class="line"><span class="string">        :param sock: 套接字</span></span><br><span class="line"><span class="string">        :return: data接收到的一行数据</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        data = <span class="string">""</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> data.endswith(self.line_sep):</span><br><span class="line">            d = sock.recv(<span class="number">1</span>)</span><br><span class="line">            data += d.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__parse_cmd</span><span class="params">(self, cmd_str)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        从字符串中解析命令</span></span><br><span class="line"><span class="string">        :param cmd_str: 命令字符串</span></span><br><span class="line"><span class="string">        :return: 返回命令动词(大写)，命令参数</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">' '</span> <span class="keyword">in</span> cmd_str:</span><br><span class="line">            cmd_lst = cmd_str.split(<span class="string">' '</span>)</span><br><span class="line">            cmd = cmd_lst[<span class="number">0</span>]</span><br><span class="line">            args = <span class="string">' '</span>.join(cmd_lst[<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cmd = cmd_str</span><br><span class="line">            args = <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> cmd.upper(), args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_cmd</span><span class="params">(self, cmd, args=<span class="string">""</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        发送命令</span></span><br><span class="line"><span class="string">        :param cmd: 命令动词</span></span><br><span class="line"><span class="string">        :param args: 命令参数</span></span><br><span class="line"><span class="string">        :return: 返回命令发送成功与否</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.sock:</span><br><span class="line">            <span class="keyword">if</span> args:</span><br><span class="line">                cmd = <span class="string">' '</span>.join((cmd, args))</span><br><span class="line">                <span class="keyword">if</span> cmd.startswith(<span class="string">"RETR"</span>) <span class="keyword">or</span> cmd.startswith(<span class="string">"STOR"</span>):</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> self.pasv_mode:</span><br><span class="line">                        print(<span class="string">"Please enter passive mode first"</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> args:</span><br><span class="line">                        print(<span class="string">"Please specify a file"</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">                <span class="keyword">if</span> cmd.startswith(<span class="string">"STOR"</span>):</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args):</span><br><span class="line">                        print(<span class="string">"File not exist"</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">            cmd += self.line_sep</span><br><span class="line">            self.sock.sendall(cmd.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        循环执行用户输入的命令</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        print(<span class="string">"Supported Commands: "</span>, self.cmds)</span><br><span class="line">        self.__cmd_connect()  <span class="comment"># 连接</span></span><br><span class="line">        self.__login()  <span class="comment"># 登陆</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            cmd_str = input(<span class="string">"Enter your commands: "</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cmd_str:</span><br><span class="line">                print(<span class="string">"FTP command can not be empty"</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            cmd, args = self.__parse_cmd(cmd_str)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.send_cmd(cmd, args):</span><br><span class="line">                print(<span class="string">"Fail to send your command: "</span>, cmd)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            res = self.read_line(self.sock)</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">if</span> cmd.startswith(<span class="string">"PASV"</span>) <span class="keyword">and</span> res.startswith(<span class="string">"227"</span>):</span><br><span class="line">                self.pasv_mode = <span class="keyword">True</span></span><br><span class="line">                server_info = res[res.index(<span class="string">'('</span>) + <span class="number">1</span>:res.index(<span class="string">')'</span>)]</span><br><span class="line">                self.pasv_host = <span class="string">'.'</span>.join(server_info.split(<span class="string">','</span>)[:<span class="number">4</span>])</span><br><span class="line">                server_info = server_info.split(<span class="string">','</span>)[<span class="number">-2</span>:]</span><br><span class="line">                self.pasv_port = int(server_info[<span class="number">0</span>]) * <span class="number">256</span> + int(server_info[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">if</span> cmd.startswith(<span class="string">"RETR"</span>):  <span class="comment"># 下载文件</span></span><br><span class="line">                <span class="keyword">if</span> self.pasv_mode:</span><br><span class="line">                    threading.Thread(target=get_file, args=(self.pasv_host, self.pasv_port, args)).start()</span><br><span class="line">            <span class="keyword">if</span> cmd.startswith(<span class="string">"STOR"</span>):  <span class="comment"># 上传文件</span></span><br><span class="line">                <span class="keyword">if</span> self.pasv_mode:</span><br><span class="line">                    threading.Thread(target=put_data, args=(self.pasv_host, self.pasv_port, args)).start()</span><br><span class="line">            <span class="keyword">if</span> cmd.startswith(<span class="string">"QUIT"</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        self.sock.close()</span><br><span class="line">        self.sock = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ftp_client = FTPClient()</span><br><span class="line">    ftp_client.start()</span><br></pre></td></tr></table></figure>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-10-17T14:55:41.302Z" itemprop="dateUpdated">2018-10-17 22:55:41</time>
</span><br>


        
        <a href="/2018/10/17/python-socket/" target="_blank" rel="external">https://suda-morris.github.io/2018/10/17/python-socket/</a>
        
    </div>
    
    <footer>
        <a href="https://suda-morris.github.io">
            <img src="/img/avatar.jpg" alt="suda-morris">
            suda-morris
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Socket/">Socket</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://suda-morris.github.io/2018/10/17/python-socket/&title=《Python Socket》 — suda-morris's Personal Blog&pic=https://suda-morris.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://suda-morris.github.io/2018/10/17/python-socket/&title=《Python Socket》 — suda-morris's Personal Blog&source=茅小泰的个人博客" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://suda-morris.github.io/2018/10/17/python-socket/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Python Socket》 — suda-morris's Personal Blog&url=https://suda-morris.github.io/2018/10/17/python-socket/&via=https://suda-morris.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://suda-morris.github.io/2018/10/17/python-socket/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/10/29/pyside2/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">pyside2</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/10/15/logistic-regression/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Logistic Regression</h4>
      </a>
    </div>
  
</nav>



    








<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            id: 'Wed Oct 17 2018 22:36:12 GMT+0800',
            owner: 'suda-morris',
            repo: 'suda-morris.github.io',
            oauth: {
                client_id: 'c57bf626196975c975bd',
                client_secret: '2d6206807459e263b680e92344b96bc324ac4157',
            },
        })
        gitment.render('comments')
    </script>
</section>










</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>suda-morris &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://suda-morris.github.io/2018/10/17/python-socket/&title=《Python Socket》 — suda-morris's Personal Blog&pic=https://suda-morris.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://suda-morris.github.io/2018/10/17/python-socket/&title=《Python Socket》 — suda-morris's Personal Blog&source=茅小泰的个人博客" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://suda-morris.github.io/2018/10/17/python-socket/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Python Socket》 — suda-morris's Personal Blog&url=https://suda-morris.github.io/2018/10/17/python-socket/&via=https://suda-morris.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://suda-morris.github.io/2018/10/17/python-socket/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKElEQVR42u3awW6EMAwE0P7/T7fXHgqdiWklkscJrYDkZSXLsfPxEV+f366r3++v5Jv3zz9wYWBgvJaRDL/2y9X3k9HzuWFgYJzDuIpg9/f580nYvWLcj4WBgYFx9UybFLYpIwYGBsY84CYTuh8lTzcxMDAw8nAZfe524/rUkmFgYJzGyKvu/3//J/0NDAyMVzE+yysJiEm5bbIl/mFEDAyMrRl5gJuU1VpYOx8MDIy9Ge0RivaARX4IIynMFX8NBgbGMYw2mVsL1mslvyLgYmBgvJyRTD0Jl8VggwbnL29hYGBsykhSurxV0L671qq8rBpiYGBsymin+EACF2Dyoxt13xUDA2NTxlph7qkkMtlIY2BgnMDIX56ngO261uU2DAyMTRlt0pYfkshboW3QjxJEDAyMLRjtBjIPmk8F4jqTxcDA2JSxVszKt7VtEG/DNwYGxpmM5PhFu/lMeIuLiIGBsTVj0nRsn2wbonU7EwMD4xhGMt1Jq6ANzcVCY2BgHMB4IOQNDlisbXd/CLgYGBhbM+oi11LLM28StM9gYGCcyZiT2q+tpZIYGBh7M54tfj3FyL8Q5bYYGBgvZ7RFsXzSbcuhzfHalicGBsbbGfkxi/shc1i+Zc3HxcDAOIExL8PlxbJJ2lcctsDAwDie0QbfyX4zmgMGBgbGYE+cH6oYLRAGBsYBjGQTmxfX8hL/vHmAgYFxAqM94pCX/tuFmLQKMDAwNmV8AcFj0T8bQ75GAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '死鬼去哪里了！';
            clearTimeout(titleTime);
        } else {
            document.title = '(つェ⊂)咦!又好了!';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
